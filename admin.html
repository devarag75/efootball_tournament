<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel â€“ Arjun Cup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>ðŸ›  Admin Panel</h1>
  <p>Arjun Cup â€“ Match Management</p>
</header>

<section class="admin-info">
  <span id="adminStatus">Checking admin...</span>
  <button id="logoutBtn">Logout</button>
</section>

<section class="admin-form">
  <h2>Add Match Result</h2>

  <label>Team A</label>
  <select id="teamA"><option value="">Select Team</option></select>

  <label>Goals (Team A)</label>
  <input type="number" id="goalsA" min="0" />

  <label>Team B</label>
  <select id="teamB"><option value="">Select Team</option></select>

  <label>Goals (Team B)</label>
  <input type="number" id="goalsB" min="0" />

  <label>Round</label>
  <select id="round">
    <option value="Group Stage">Group Stage</option>
    <option value="Quarter Final">Quarter Final</option>
    <option value="Semi Final">Semi Final</option>
    <option value="Final">Final</option>
  </select>

  <button id="saveBtn">Save Match</button>
  <p id="msg"></p>
</section>

<section class="admin-form">
  <h2>Existing Matches</h2>
  <div id="matchList"></div>
</section>

<footer>
  <p>Admin â€¢ Arjun Cup Â© 2026</p>
</footer>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection, addDoc, getDocs, updateDoc, deleteDoc,
    doc, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const teamASelect = document.getElementById("teamA");
  const teamBSelect = document.getElementById("teamB");
  const msg = document.getElementById("msg");
  const matchList = document.getElementById("matchList");

  onAuthStateChanged(auth, async (user) => {
    if (!user) location.href = "login.html";
    document.getElementById("adminStatus").innerText = user.email;
    await loadTeams();
    await loadMatches();
  });

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "login.html";
  };

  async function loadTeams() {
    teamASelect.innerHTML = '<option value="">Select Team</option>';
    teamBSelect.innerHTML = '<option value="">Select Team</option>';
    const snap = await getDocs(collection(db, "teams"));
    snap.forEach(d => {
      ["A","B"].forEach(x => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.id.toUpperCase();
        (x==="A"?teamASelect:teamBSelect).appendChild(opt);
      });
    });
  }

  async function recalcPoints() {
    const teamsSnap = await getDocs(collection(db, "teams"));
    const teams = {};
    teamsSnap.forEach(d => teams[d.id] = {
      matches:0,wins:0,draws:0,losses:0,goalDifference:0,points:0
    });

    const matchesSnap = await getDocs(collection(db, "matches"));
    matchesSnap.forEach(d => {
      const { teamA, teamB, goalsA, goalsB } = d.data();
      teams[teamA].matches++; teams[teamB].matches++;
      teams[teamA].goalDifference += goalsA-goalsB;
      teams[teamB].goalDifference += goalsB-goalsA;

      if (goalsA > goalsB) {
        teams[teamA].wins++; teams[teamA].points+=3; teams[teamB].losses++;
      } else if (goalsB > goalsA) {
        teams[teamB].wins++; teams[teamB].points+=3; teams[teamA].losses++;
      } else {
        teams[teamA].draws++; teams[teamB].draws++;
        teams[teamA].points++; teams[teamB].points++;
      }
    });

    for (const t in teams)
      await updateDoc(doc(db,"teams",t), teams[t]);
  }

  document.getElementById("saveBtn").onclick = async () => {
    await addDoc(collection(db,"matches"), {
      teamA: teamASelect.value,
      teamB: teamBSelect.value,
      goalsA: Number(goalsA.value),
      goalsB: Number(goalsB.value),
      round: round.value,
      createdAt: serverTimestamp()
    });
    await recalcPoints();
    msg.innerText = "âœ… Match saved";
    loadMatches();
  };

  async function loadMatches() {
    matchList.innerHTML = "";
    const q = query(collection(db,"matches"), orderBy("createdAt","desc"));
    const snap = await getDocs(q);

    snap.forEach(d => {
      const m = d.data();
      const div = document.createElement("div");
      div.className = "match-card";
      div.innerHTML = `
        <b>${m.teamA.toUpperCase()} ${m.goalsA} - ${m.goalsB} ${m.teamB.toUpperCase()}</b>
        <small>${m.round}</small>
        <button onclick="deleteMatch('${d.id}')">ðŸ—‘ Delete</button>
      `;
      matchList.appendChild(div);
    });
  }

  window.deleteMatch = async (id) => {
    if (!confirm("Delete this match?")) return;
    await deleteDoc(doc(db,"matches",id));
    await recalcPoints();
    loadMatches();
  };
</script>

</body>
</html>
